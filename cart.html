<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>购物车 | Shop</title>
  <style>
    /* 省略了 CSS 样式，与原版一致 */
  </style>
</head>
<body>
  <h1>🛒 购物车</h1>
  
  <div class="cart-container">
    <table id="cart-table">
      <thead>
        <tr>
          <th>商品名称</th>
          <th>单价</th>
          <th>数量</th>
          <th>总价</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="cart-body">
        <!-- 购物车商品动态填充 -->
      </tbody>
    </table>
    <p class="total">总计: ¥<span id="cart-total">0</span></p>
    <button class="checkout-btn" id="checkout-btn">结账</button>
  </div>

  <!-- 结账弹出框 -->
  <div id="checkout-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="close-checkout-modal">&times;</span>
      <h2>确认下单</h2>
      <form id="checkout-form" class="checkout-form">
        <label for="checkout-name">姓名</label>
        <input type="text" id="checkout-name" readonly>
        
        <label for="checkout-email">电子邮件</label>
        <input type="email" id="checkout-email" readonly>
        
        <label for="checkout-phone">电话号码</label>
        <input type="text" id="checkout-phone" readonly>
        
        <label for="checkout-address">收货地址</label>
        <textarea id="checkout-address" rows="3" readonly></textarea>
        
        <h3>订单摘要</h3>
        <div id="order-summary" class="order-summary">
          <!-- 显示购物车商品摘要 -->
        </div>
        
        <button type="submit" class="save-order-btn">确认下单</button>
      </form>
    </div>
  </div>

  <script type="module">
    // 导入 Firebase 模块
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Firebase 配置
    const firebaseConfig = {
      apiKey: "AIzaSyCh7tgqEZb1zLICy6trriTCMJlXEe0x6hM",
      authDomain: "shop-87351.firebaseapp.com",
      projectId: "shop-87351",
      storageBucket: "shop-87351.appspot.com",
      messagingSenderId: "994764608061",
      appId: "1:994764608061:web:e7a5a041cd3e082daad054"
    };

    // 初始化 Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // 读取 Firestore 购物车数据
    async function loadCart() {
      const cartBody = document.getElementById("cart-body");
      const cartTotal = document.getElementById("cart-total");
      cartBody.innerHTML = "";
      let total = 0;

      const querySnapshot = await getDocs(collection(db, "cart"));
      querySnapshot.forEach((doc) => {
        const item = doc.data();
        const row = document.createElement("tr");
        const itemTotal = item.price * item.quantity;
        total += itemTotal;

        row.innerHTML = `
          <td>${item.name}</td>
          <td>¥${item.price.toFixed(2)}</td>
          <td>${item.quantity}</td>
          <td>¥${itemTotal.toFixed(2)}</td>
          <td><button class="remove-btn" data-id="${doc.id}">删除</button></td>
        `;
        cartBody.appendChild(row);
      });

      cartTotal.textContent = total.toFixed(2);
    }

    // 删除商品
    document.getElementById("cart-body").addEventListener("click", async (e) => {
      if (e.target.classList.contains("remove-btn")) {
        const id = e.target.getAttribute("data-id");
        await deleteDoc(doc(db, "cart", id));
        loadCart();
      }
    });

    loadCart(); // 加载购物车数据

    // 绑定结账按钮，显示订单信息
    document.getElementById("checkout-btn").addEventListener("click", () => {
      const orderSummary = document.getElementById("order-summary");
      orderSummary.innerHTML = "";
      document.getElementById("checkout-modal").style.display = "flex";
    });

    // 关闭结账窗口
    document.getElementById("close-checkout-modal").addEventListener("click", () => {
      document.getElementById("checkout-modal").style.display = "none";
    });

    // 提交订单
    document.getElementById("checkout-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const cartItems = await getDocs(collection(db, "cart"));
      if (cartItems.empty) {
        alert("购物车为空，无法下单！");
        return;
      }

      const orderData = {
        items: [],
        total: document.getElementById("cart-total").textContent,
        orderTime: new Date().toISOString()
      };

      cartItems.forEach((doc) => {
        orderData.items.push(doc.data());
      });

      try {
        await addDoc(collection(db, "orders"), orderData);
        cartItems.forEach(async (item) => {
          await deleteDoc(doc(db, "cart", item.id)); // 清空购物车
        });

        alert("订单提交成功！");
        loadCart(); // 重新加载购物车
        document.getElementById("checkout-modal").style.display = "none";
      } catch (error) {
        console.error("下单失败：", error);
        alert("下单失败，请稍后再试！");
      }
    });
  </script>
</body>
</html>
