<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è´­ç‰©è½¦ | Shop</title>
  <style>
    /* çœç•¥äº† CSS æ ·å¼ï¼Œä¸åŸç‰ˆä¸€è‡´ */
  </style>
</head>
<body>
  <h1>ğŸ›’ è´­ç‰©è½¦</h1>
  
  <div class="cart-container">
    <table id="cart-table">
      <thead>
        <tr>
          <th>å•†å“åç§°</th>
          <th>å•ä»·</th>
          <th>æ•°é‡</th>
          <th>æ€»ä»·</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="cart-body">
        <!-- è´­ç‰©è½¦å•†å“åŠ¨æ€å¡«å…… -->
      </tbody>
    </table>
    <p class="total">æ€»è®¡: Â¥<span id="cart-total">0</span></p>
    <button class="checkout-btn" id="checkout-btn">ç»“è´¦</button>
  </div>

  <!-- ç»“è´¦å¼¹å‡ºæ¡† -->
  <div id="checkout-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="close-checkout-modal">&times;</span>
      <h2>ç¡®è®¤ä¸‹å•</h2>
      <form id="checkout-form" class="checkout-form">
        <label for="checkout-name">å§“å</label>
        <input type="text" id="checkout-name" readonly>
        
        <label for="checkout-email">ç”µå­é‚®ä»¶</label>
        <input type="email" id="checkout-email" readonly>
        
        <label for="checkout-phone">ç”µè¯å·ç </label>
        <input type="text" id="checkout-phone" readonly>
        
        <label for="checkout-address">æ”¶è´§åœ°å€</label>
        <textarea id="checkout-address" rows="3" readonly></textarea>
        
        <h3>è®¢å•æ‘˜è¦</h3>
        <div id="order-summary" class="order-summary">
          <!-- æ˜¾ç¤ºè´­ç‰©è½¦å•†å“æ‘˜è¦ -->
        </div>
        
        <button type="submit" class="save-order-btn">ç¡®è®¤ä¸‹å•</button>
      </form>
    </div>
  </div>

  <script type="module">
    // å¯¼å…¥ Firebase æ¨¡å—
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyCh7tgqEZb1zLICy6trriTCMJlXEe0x6hM",
      authDomain: "shop-87351.firebaseapp.com",
      projectId: "shop-87351",
      storageBucket: "shop-87351.appspot.com",
      messagingSenderId: "994764608061",
      appId: "1:994764608061:web:e7a5a041cd3e082daad054"
    };

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // è¯»å– Firestore è´­ç‰©è½¦æ•°æ®
    async function loadCart() {
      const cartBody = document.getElementById("cart-body");
      const cartTotal = document.getElementById("cart-total");
      cartBody.innerHTML = "";
      let total = 0;

      const querySnapshot = await getDocs(collection(db, "cart"));
      querySnapshot.forEach((doc) => {
        const item = doc.data();
        const row = document.createElement("tr");
        const itemTotal = item.price * item.quantity;
        total += itemTotal;

        row.innerHTML = `
          <td>${item.name}</td>
          <td>Â¥${item.price.toFixed(2)}</td>
          <td>${item.quantity}</td>
          <td>Â¥${itemTotal.toFixed(2)}</td>
          <td><button class="remove-btn" data-id="${doc.id}">åˆ é™¤</button></td>
        `;
        cartBody.appendChild(row);
      });

      cartTotal.textContent = total.toFixed(2);
    }

    // åˆ é™¤å•†å“
    document.getElementById("cart-body").addEventListener("click", async (e) => {
      if (e.target.classList.contains("remove-btn")) {
        const id = e.target.getAttribute("data-id");
        await deleteDoc(doc(db, "cart", id));
        loadCart();
      }
    });

    loadCart(); // åŠ è½½è´­ç‰©è½¦æ•°æ®

    // ç»‘å®šç»“è´¦æŒ‰é’®ï¼Œæ˜¾ç¤ºè®¢å•ä¿¡æ¯
    document.getElementById("checkout-btn").addEventListener("click", () => {
      const orderSummary = document.getElementById("order-summary");
      orderSummary.innerHTML = "";
      document.getElementById("checkout-modal").style.display = "flex";
    });

    // å…³é—­ç»“è´¦çª—å£
    document.getElementById("close-checkout-modal").addEventListener("click", () => {
      document.getElementById("checkout-modal").style.display = "none";
    });

    // æäº¤è®¢å•
    document.getElementById("checkout-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const cartItems = await getDocs(collection(db, "cart"));
      if (cartItems.empty) {
        alert("è´­ç‰©è½¦ä¸ºç©ºï¼Œæ— æ³•ä¸‹å•ï¼");
        return;
      }

      const orderData = {
        items: [],
        total: document.getElementById("cart-total").textContent,
        orderTime: new Date().toISOString()
      };

      cartItems.forEach((doc) => {
        orderData.items.push(doc.data());
      });

      try {
        await addDoc(collection(db, "orders"), orderData);
        cartItems.forEach(async (item) => {
          await deleteDoc(doc(db, "cart", item.id)); // æ¸…ç©ºè´­ç‰©è½¦
        });

        alert("è®¢å•æäº¤æˆåŠŸï¼");
        loadCart(); // é‡æ–°åŠ è½½è´­ç‰©è½¦
        document.getElementById("checkout-modal").style.display = "none";
      } catch (error) {
        console.error("ä¸‹å•å¤±è´¥ï¼š", error);
        alert("ä¸‹å•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼");
      }
    });
  </script>
</body>
</html>
