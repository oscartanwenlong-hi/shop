<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单列表 | Shop</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
        }
        th {
            background-color: #f4f4f4;
        }
        .details {
            display: none;
            text-align: left;
        }
        button {
            cursor: pointer;
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
    <script type="module">
        // ✅ 引入 Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // ✅ Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyCh7tgqEZb1zLICy6trriTCMJlXEe0x6hM",
            authDomain: "shop-87351.firebaseapp.com",
            projectId: "shop-87351",
            storageBucket: "shop-87351.appspot.com",
            messagingSenderId: "994764608061",
            appId: "1:994764608061:web:e7a5a041cd3e082daad054"
        };

        // ✅ 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ✅ 获取 `orders` 数据
        async function loadOrders() {
            const ordersTableBody = document.getElementById("orders-table-body");
            ordersTableBody.innerHTML = "<tr><td colspan='8'>加载中...</td></tr>";

            try {
                const ordersCollection = collection(db, "orders");
                const ordersSnapshot = await getDocs(ordersCollection);
                
                let ordersHtml = "";
                
                ordersSnapshot.forEach((doc) => {
                    const order = doc.data();
                    const { customer, items, ordersnumber, timestamp, total } = order;

                    // ✅ 格式化时间
                    const date = timestamp ? new Date(timestamp) : "未知";
                    const formattedDate = date instanceof Date ? date.toLocaleString("zh-CN") : "未知";

                    // ✅ 生成 HTML 代码
                    ordersHtml += `
                        <tr>
                            <td>${ordersnumber || "未知"}</td>
                            <td>${customer.name || "未知"}</td>
                            <td>${customer.email || "未知"}</td>
                            <td>${customer.phone || "未知"}</td>
                            <td>${customer.address || "未知"}</td>
                            <td>${formattedDate}</td>
                            <td>￥${total || 0}</td>
                            <td>
                                <button onclick="toggleItems('${doc.id}')">查看</button>
                                <div id="items-${doc.id}" class="details">
                                    ${items.map(item => `
                                        <p>📌 ${item.name} - ￥${item.price} x ${item.quantity}</p>
                                    `).join("")}
                                </div>
                            </td>
                        </tr>
                    `;
                });

                ordersTableBody.innerHTML = ordersHtml;
            } catch (error) {
                console.error("❌ 加载订单失败:", error);
                ordersTableBody.innerHTML = "<tr><td colspan='8'>❌ 加载失败</td></tr>";
            }
        }

        // ✅ 展开/折叠商品详情
        window.toggleItems = function(orderId) {
            const itemsDiv = document.getElementById(`items-${orderId}`);
            itemsDiv.style.display = itemsDiv.style.display === "none" ? "block" : "none";
        };

        // ✅ 页面加载完成后获取订单数据
        document.addEventListener("DOMContentLoaded", loadOrders);
    </script>
</head>
<body>
    <h1>订单列表</h1>
    <table>
        <thead>
            <tr>
                <th>订单号</th>
                <th>客户姓名</th>
                <th>客户邮箱</th>
                <th>电话</th>
                <th>地址</th>
                <th>订单时间</th>
                <th>总价</th>
                <th>商品详情</th>
            </tr>
        </thead>
        <tbody id="orders-table-body">
            <!-- 订单数据会在这里动态插入 -->
        </tbody>
    </table>
</body>
</html>
