<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è´­ç‰©è½¦ | Shop</title>
  <style>
    /* å…¨å±€æ ·å¼ */
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      background-color: #ff6b6b;
      color: white;
      padding: 15px;
      margin: 0;
    }
    .cart-container {
      width: 80%;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #ff6b6b;
      color: white;
    }
    .total {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
    }
    .checkout-btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
      border-radius: 5px;
    }
    .checkout-btn:hover {
      background-color: #218838;
    }
    /* ç»“è´¦å¼¹å‡ºæ¡† */
    .modal {
      display: none; /* é»˜è®¤éšè— */
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      width: 40%;
      border-radius: 10px;
      text-align: left;
      position: relative;
    }
    .close-btn {
      position: absolute;
      right: 15px;
      top: 10px;
      font-size: 24px;
      cursor: pointer;
    }
    .checkout-form label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    .checkout-form input, 
    .checkout-form textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .save-order-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px;
      width: 100%;
      border-radius: 5px;
      cursor: pointer;
      font-size: 18px;
    }
    .save-order-btn:hover {
      background: #0056b3;
    }
    /* è®¢å•æ‘˜è¦æ ·å¼ */
    .order-summary {
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      background: #f1f1f1;
    }
    .order-summary ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .order-summary li {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h1>ğŸ›’ è´­ç‰©è½¦</h1>
  
  <div class="cart-container">
    <table id="cart-table">
      <thead>
        <tr>
          <th>å•†å“åç§°</th>
          <th>å•ä»·</th>
          <th>æ•°é‡</th>
          <th>æ€»ä»·</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="cart-body">
        <!-- è´­ç‰©è½¦å•†å“åŠ¨æ€å¡«å…… -->
      </tbody>
    </table>
    <p class="total">æ€»è®¡: Â¥<span id="cart-total">0</span></p>
    <button class="checkout-btn" id="checkout-btn">ç»“è´¦</button>
  </div>
  
  <!-- ç»“è´¦å¼¹å‡ºæ¡† -->
  <div id="checkout-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="close-checkout-modal">&times;</span>
      <h2>ç¡®è®¤ä¸‹å•</h2>
      <form id="checkout-form" class="checkout-form">
        <label for="checkout-name">å§“å</label>
        <input type="text" id="checkout-name" readonly>
        
        <label for="checkout-email">ç”µå­é‚®ä»¶</label>
        <input type="email" id="checkout-email" readonly>
        
        <label for="checkout-phone">ç”µè¯å·ç </label>
        <input type="text" id="checkout-phone" readonly>
        
        <label for="checkout-address">æ”¶è´§åœ°å€</label>
        <textarea id="checkout-address" rows="3" readonly></textarea>
        
        <h3>è®¢å•æ‘˜è¦</h3>
        <div id="order-summary" class="order-summary">
          <!-- æ˜¾ç¤ºè´­ç‰©è½¦å•†å“æ‘˜è¦ -->
        </div>
        
        <button type="submit" class="save-order-btn">ç¡®è®¤ä¸‹å•</button>
      </form>
    </div>
  </div>
  
  <script type="module">
    // å¯¼å…¥ Firebase æ¨¡å—ï¼ˆv10.7.1ï¼‰åŠ jsPDF åº“
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { jsPDF } from "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyCh7tgqEZb1zLICy6trriTCMJlXEe0x6hM",
      authDomain: "shop-87351.firebaseapp.com",
      projectId: "shop-87351",
      storageBucket: "shop-87351.appspot.com",
      messagingSenderId: "994764608061",
      appId: "1:994764608061:web:e7a5a041cd3e082daad054"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // å½“å‰ç™»å½•ç”¨æˆ·å¯¹è±¡
    let currentUser = null;
    
    // åŠ è½½å½“å‰ç”¨æˆ·è´­ç‰©è½¦ï¼ˆä» Firestore çš„ carts/{user.uid}/items å­é›†åˆä¸­ï¼‰
    async function loadCart() {
      if (!currentUser) return;
      const cartBody = document.getElementById("cart-body");
      const cartTotalElem = document.getElementById("cart-total");
      cartBody.innerHTML = "";
      let total = 0;
      const itemsSnapshot = await getDocs(collection(db, "carts", currentUser.uid, "items"));
      let cartItems = [];
      itemsSnapshot.forEach((docSnap) => {
        const item = { id: docSnap.id, ...docSnap.data() };
        cartItems.push(item);
      });
      cartItems.forEach((item) => {
        const price = parseFloat(item.price) || 0;
        const quantity = item.quantity || 1;
        const itemTotal = price * quantity;
        total += itemTotal;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.name}</td>
          <td>Â¥${price.toFixed(2)}</td>
          <td>${quantity}</td>
          <td>Â¥${itemTotal.toFixed(2)}</td>
          <td><button class="remove-btn" data-id="${item.id}">åˆ é™¤</button></td>
        `;
        cartBody.appendChild(row);
      });
      cartTotalElem.textContent = total.toFixed(2);
    }
    
    // åˆ é™¤è´­ç‰©è½¦ä¸­æŸä¸ªå•†å“ï¼ˆä» Firestore åˆ é™¤å¯¹åº”æ–‡æ¡£ï¼‰
    async function deleteCartItem(itemId) {
      if (!currentUser) return;
      await deleteDoc(doc(db, "carts", currentUser.uid, "items", itemId));
      loadCart();
    }
    
    // ç»‘å®šåˆ é™¤æŒ‰é’®ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
    document.getElementById("cart-body").addEventListener("click", (e) => {
      if (e.target.classList.contains("remove-btn")) {
        const itemId = e.target.getAttribute("data-id");
        deleteCartItem(itemId);
      }
    });
    
    // å·¥å…·å‡½æ•°ï¼šç”Ÿæˆä¸‹ä¸€ä¸ªè®¢å•å·
    async function generateNextOrderNumber() {
      const ordersRef = collection(db, "orders");
      const q = query(ordersRef, orderBy("orderNumber", "desc"), limit(1));
      const querySnapshot = await getDocs(q);
      let newOrderNumber;
      if (querySnapshot.empty) {
        newOrderNumber = "A001";
      } else {
        const lastOrder = querySnapshot.docs[0].data();
        const lastOrderNumber = lastOrder.orderNumber;
        const letter = lastOrderNumber.charAt(0);
        const num = parseInt(lastOrderNumber.slice(1));
        if (num < 999) {
          newOrderNumber = letter + String(num + 1).padStart(3, "0");
        } else {
          const nextLetter = String.fromCharCode(letter.charCodeAt(0) + 1);
          newOrderNumber = nextLetter + "001";
        }
      }
      return newOrderNumber;
    }
    
    // å¡«å……ç»“è´¦å¼¹å‡ºæ¡†ä¸­çš„è®¢å•æ‘˜è¦
    async function fillOrderSummary() {
      if (!currentUser) return;
      const orderSummary = document.getElementById("order-summary");
      orderSummary.innerHTML = "";
      const itemsSnapshot = await getDocs(collection(db, "carts", currentUser.uid, "items"));
      itemsSnapshot.forEach((docSnap) => {
        const item = docSnap.data();
        const li = document.createElement("li");
        li.textContent = `${item.name} - æ•°é‡: ${item.quantity || 1} - å•ä»·: Â¥${parseFloat(item.price).toFixed(2)}`;
        orderSummary.appendChild(li);
      });
    }
    
    // ç»“è´¦æŒ‰é’®äº‹ä»¶ï¼šæ˜¾ç¤ºç»“è´¦å¼¹å‡ºæ¡†ï¼Œå¹¶å¡«å……ç”¨æˆ·ä¿¡æ¯å’Œè®¢å•æ‘˜è¦
    document.getElementById("checkout-btn").addEventListener("click", () => {
      fillOrderSummary();
      // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;
          const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
          const userDocRef = doc(db, "users", user.uid);
          const userSnap = await getDoc(userDocRef);
          if (userSnap.exists()) {
            const userData = userSnap.data();
            document.getElementById("checkout-name").value = userData.name || "";
            document.getElementById("checkout-email").value = userData.email || "";
            document.getElementById("checkout-phone").value = userData.phone || "";
            document.getElementById("checkout-address").value = userData.address || "";
          }
        }
      });
      document.getElementById("checkout-modal").style.display = "flex";
    });
    
    // å…³é—­ç»“è´¦å¼¹å‡ºæ¡†
    document.getElementById("close-checkout-modal").addEventListener("click", () => {
      document.getElementById("checkout-modal").style.display = "none";
    });
    
    // å¤„ç†ç»“è´¦è¡¨å•æäº¤ï¼šç”Ÿæˆè®¢å•å·ã€å†™å…¥è®¢å•æ•°æ®ã€ç”Ÿæˆ PDFã€å¹¶æ¸…ç©ºè´­ç‰©è½¦ï¼ˆä» Firestore åˆ é™¤æ‰€æœ‰ itemsï¼‰
    document.getElementById("checkout-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("checkout-name").value;
      const email = document.getElementById("checkout-email").value;
      const phone = document.getElementById("checkout-phone").value;
      const address = document.getElementById("checkout-address").value;
      const total = document.getElementById("cart-total").textContent;
      const orderTime = new Date().toISOString();
      
      const newOrderNumber = await generateNextOrderNumber();
      
      // è·å–æ‰€æœ‰è´­ç‰©è½¦é¡¹ç›®
      const itemsSnapshot = await getDocs(collection(db, "carts", currentUser.uid, "items"));
      let cartItems = [];
      itemsSnapshot.forEach((docSnap) => {
        cartItems.push({ id: docSnap.id, ...docSnap.data() });
      });
      
      const orderData = {
        orderNumber: newOrderNumber,
        customer: { name, email, phone, address },
        items: cartItems,
        total: total,
        orderTime: orderTime
      };
      
      try {
        await addDoc(collection(db, "orders"), orderData);
        
        // ç”Ÿæˆ PDF
        const docPDF = new jsPDF();
        docPDF.setFontSize(16);
        docPDF.text("è®¢å•è¯¦æƒ…", 10, 20);
        docPDF.setFontSize(12);
        docPDF.text("è®¢å•å·: " + newOrderNumber, 10, 30);
        docPDF.text("å§“å: " + name, 10, 40);
        docPDF.text("ç”µå­é‚®ä»¶: " + email, 10, 50);
        docPDF.text("ç”µè¯å·ç : " + phone, 10, 60);
        docPDF.text("æ”¶è´§åœ°å€: " + address, 10, 70);
        docPDF.text("è®¢å•æ‘˜è¦:", 10, 80);
        let yPos = 90;
        cartItems.forEach((item, i) => {
          docPDF.text(`${i+1}. ${item.name} - æ•°é‡: ${item.quantity || 1} - å•ä»·: Â¥${parseFloat(item.price).toFixed(2)}`, 10, yPos);
          yPos += 10;
        });
        docPDF.text("æ€»è®¡: Â¥" + total, 10, yPos + 10);
        docPDF.save("order_" + newOrderNumber + ".pdf");
        
        // åˆ é™¤è´­ç‰©è½¦ä¸­æ‰€æœ‰å•†å“ï¼ˆåˆ é™¤ Firestore å­é›†åˆä¸­çš„æ–‡æ¡£ï¼‰
        for (let item of cartItems) {
          await deleteDoc(doc(db, "carts", currentUser.uid, "items", item.id));
        }
        
        alert("ä¸‹å•æˆåŠŸï¼è®¢å•å·ä¸ºï¼š" + newOrderNumber);
        loadCart();
        document.getElementById("checkout-modal").style.display = "none";
      } catch (error) {
        console.error("ä¸‹å•å¤±è´¥ï¼š", error);
        alert("ä¸‹å•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼");
      }
    });
    
    // åˆå§‹åŠ è½½è´­ç‰©è½¦æ•°æ®ï¼Œå½“ç”¨æˆ·ç™»å½•å
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        loadCart();
      } else {
        window.location.href = "login.html";
      }
    });
  </script>
</body>
</html>
