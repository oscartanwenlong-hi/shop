<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>购物车 | Shop</title>
  <style>
    /* 全局样式 */
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      background-color: #ff6b6b;
      color: white;
      padding: 15px;
      margin: 0;
    }
    .cart-container {
      width: 80%;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #ff6b6b;
      color: white;
    }
    .total {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
    }
    .checkout-btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
      border-radius: 5px;
    }
    .checkout-btn:hover {
      background-color: #218838;
    }
    /* 弹出框样式 */
    .modal {
      display: none; /* 默认隐藏 */
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      width: 40%;
      border-radius: 10px;
      text-align: left;
      position: relative;
    }
    .close-btn {
      position: absolute;
      right: 15px;
      top: 10px;
      font-size: 24px;
      cursor: pointer;
    }
    .checkout-form label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    .checkout-form input, .checkout-form textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .save-order-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px;
      width: 100%;
      border-radius: 5px;
      cursor: pointer;
      font-size: 18px;
    }
    .save-order-btn:hover {
      background: #0056b3;
    }
    /* 订单摘要样式 */
    .order-summary {
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      background: #f1f1f1;
    }
    .order-summary h3 {
      margin: 5px 0;
    }
    .order-summary ul {
      list-style: none;
      padding: 0;
    }
    .order-summary li {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h1>🛒 购物车</h1>
  
  <div class="cart-container">
    <table id="cart-table">
      <thead>
        <tr>
          <th>商品名称</th>
          <th>单价</th>
          <th>数量</th>
          <th>总价</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="cart-body">
        <!-- 购物车商品动态填充 -->
      </tbody>
    </table>
    <p class="total">总计: ¥<span id="cart-total">0</span></p>
    <button class="checkout-btn" id="checkout-btn">结账</button>
  </div>
  
  <!-- 结账弹出框 -->
  <div id="checkout-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="close-checkout-modal">&times;</span>
      <h2>确认下单</h2>
      <form id="checkout-form" class="checkout-form">
        <label for="checkout-name">姓名</label>
        <input type="text" id="checkout-name" placeholder="请输入您的姓名" required>
        
        <label for="checkout-email">电子邮件</label>
        <input type="email" id="checkout-email" placeholder="请输入您的电子邮件" required>
        
        <label for="checkout-phone">电话号码</label>
        <input type="text" id="checkout-phone" placeholder="请输入您的电话号码" required>
        
        <label for="checkout-address">收货地址</label>
        <textarea id="checkout-address" placeholder="请输入您的收货地址" rows="3" required></textarea>
        
        <h3>订单摘要</h3>
        <div id="order-summary" class="order-summary">
          <!-- 显示购物车商品摘要 -->
        </div>
        
        <button type="submit" class="save-order-btn">确认下单</button>
      </form>
    </div>
  </div>
  
  <!-- Firebase & 页面脚本 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCh7tgqEZb1zLICy6trriTCMJlXEe0x6hM",
      authDomain: "shop-87351.firebaseapp.com",
      projectId: "shop-87351",
      storageBucket: "shop-87351.appspot.com",
      messagingSenderId: "994764608061",
      appId: "1:994764608061:web:e7a5a041cd3e082daad054"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // 模拟从 localStorage 中读取购物车数据（确保数据格式为数组，每个元素包含 name, price, quantity）
    let cart = JSON.parse(localStorage.getItem("cart")) || [];

    // 渲染购物车列表
    function renderCart() {
      const cartBody = document.getElementById("cart-body");
      const cartTotal = document.getElementById("cart-total");
      cartBody.innerHTML = "";
      let total = 0;
      cart.forEach((item, index) => {
        const price = parseFloat(item.price) || 0;
        const itemTotal = price * (item.quantity || 1);
        total += itemTotal;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.name}</td>
          <td>¥${price.toFixed(2)}</td>
          <td>${item.quantity || 1}</td>
          <td>¥${itemTotal.toFixed(2)}</td>
          <td><button class="remove-btn" data-index="${index}">删除</button></td>
        `;
        cartBody.appendChild(row);
      });
      cartTotal.textContent = total.toFixed(2);
    }

    // 绑定删除按钮事件
    document.getElementById("cart-body").addEventListener("click", (e) => {
      if (e.target.classList.contains("remove-btn")) {
        const index = e.target.getAttribute("data-index");
        cart.splice(index, 1);
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
      }
    });

    renderCart();

    // 绑定结账按钮，显示结账弹出框，并填充订单摘要
    document.getElementById("checkout-btn").addEventListener("click", () => {
      // 填充订单摘要
      const orderSummary = document.getElementById("order-summary");
      orderSummary.innerHTML = "";
      cart.forEach((item) => {
        const li = document.createElement("li");
        li.textContent = `${item.name} - 数量: ${item.quantity || 1} - 单价: ¥${parseFloat(item.price).toFixed(2)}`;
        orderSummary.appendChild(li);
      });
      document.getElementById("checkout-modal").style.display = "flex";
    });

    // 关闭结账弹出框
    document.getElementById("close-checkout-modal").addEventListener("click", () => {
      document.getElementById("checkout-modal").style.display = "none";
    });

    // 处理结账表单提交
    document.getElementById("checkout-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      // 收集用户输入的个人资料
      const name = document.getElementById("checkout-name").value;
      const email = document.getElementById("checkout-email").value;
      const phone = document.getElementById("checkout-phone").value;
      const address = document.getElementById("checkout-address").value;
      
      // 构造订单数据
      const orderData = {
        customer: { name, email, phone, address },
        items: cart,
        total: document.getElementById("cart-total").textContent,
        orderTime: new Date().toISOString()
      };
      
      // 将订单数据写入 Firestore 的 orders 集合
      try {
        await addDoc(collection(db, "orders"), orderData);
        alert("下单成功！");
        // 下单成功后清空购物车并关闭弹出框
        localStorage.removeItem("cart");
        cart = [];
        renderCart();
        document.getElementById("checkout-modal").style.display = "none";
      } catch (error) {
        console.error("下单失败：", error);
        alert("下单失败，请稍后再试！");
      }
    });
  </script>
</body>
</html>
